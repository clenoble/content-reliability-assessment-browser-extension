import{b as m,E as y,U as M,S as f,A as g,a as O}from"./constants-BxEPguL7.js";import{l as a}from"./logger-GwZmU3gw.js";const _=`Analyze the following text based on the provided criteria. Your primary task is to first classify the text as 'Factual', 'Opinion', or 'Fiction'. Based on that classification, you will then perform a simplified reliability assessment using only the rubric for the determined category.

Your final output must be a single JSON object adhering to the provided schema.

**Assessment Criteria:**

**A. Factual Content Rubric:**
* **Evidentiary Integrity:**
    * Indicator: Presence of quantitative data (numbers, percentages, statistics) and mentions of sources (studies, reports, research).
    * Analysis: Score 0-5. Score higher for higher density and specificity of evidence.
* **Logical Coherence:**
    * Indicator: Detection of logical fallacy markers (e.g., "everyone knows," "it's obvious that," ad hominem attacks).
    * Analysis: Score 0-5. Score *lower* if fallacy markers are present. A score of 5 means high coherence.
* **Rhetorical Style:**
    * Indicator: Analysis of language for emotional charge (e.g., "outrageous," "disastrous," "miracle").
    * Analysis: Score 0-5. Score *lower* for high prevalence of emotionally charged language. A score of 5 means neutral language.

**B. Opinion Content Rubric:**
* **Transparency of Position:**
    * Indicator: Use of first-person pronouns ("I believe," "In my view") and subjective framing.
    * Analysis: Score 0-5. Score higher for clear subjective framing (this is a *transparency* score).
* **Support for Opinion:**
    * Indicator: Presence of evidence-like statements (as per Factual assessment) used to support the opinion.
    * Analysis: Score 0-5. Score higher when opinions are supported by verifiable information.
* **Intellectual Honesty:**
    * Indicator: Phrases that acknowledge counterarguments ("although some may say," "on the other hand," "a counterpoint is").
    * Analysis: Score 0-5. Score higher for acknowledging other viewpoints.

**C. Fiction Content Rubric:**
* **Explicit Labeling:**
    * Indicator: Presence of keywords like 'Fiction,' 'Satire,' 'Short Story,' 'Parody.'
    * Analysis: Score 0-5. Score 5 if explicitly labeled, 0 if not.
* **Content & Stylistic Cues:**
    * Indicator: Presence of dialogue (quotation marks), narrative descriptions, and character development.
    * Analysis: Score 0-5. Score higher for strong, clear narrative elements (this is a *transparency* score).

**Final JSON Output:**
The output must be a single JSON object.
1.  \`classification\`: The determined category ('Factual', 'Opinion', or 'Fiction').
2.  \`finalScore\`: An overall score from 0 to 5, representing an average of the criteria scores for the *chosen* rubric.
3.  \`rawAssessment\`: An array of objects, where each object details the scoring for a specific criterion *from the chosen rubric*, including the \`indicator\`, the \`analysis\` (your reasoning), and the \`score\` assigned (0-5).`,Y={type:"OBJECT",properties:{classification:{type:"STRING",enum:["Factual","Opinion","Fiction"]},finalScore:{type:"NUMBER"},rawAssessment:{type:"ARRAY",items:{type:"OBJECT",properties:{indicator:{type:"STRING"},analysis:{type:"STRING"},score:{type:"NUMBER"}},required:["indicator","analysis","score"]}}},required:["classification","finalScore","rawAssessment"]},i="sidepanel";m.runtime.onMessage.addListener((l,h)=>(a.debug(i,"Received message",l.type),l.type==="ra_text_extracted"?(a.debug(i,"Received extracted text",{length:l.text?.length}),window.handleExtractedText&&window.handleExtractedText(l.text,l.tabInfo),Promise.resolve({ok:!0})):l.type==="ra_extraction_error"?(a.error(i,"Extraction error",l.error),window.handleExtractionError&&window.handleExtractionError(l.error),Promise.resolve({ok:!0})):Promise.resolve({ok:!1})));document.addEventListener("DOMContentLoaded",()=>{a.debug(i,"DOMContentLoaded - initializing");const l=document.getElementById("analyze-button"),h=document.getElementById("status-area"),E=document.getElementById("status-icon"),k=document.getElementById("status-message"),A=document.getElementById("status-detail"),P=document.getElementById("open-settings"),R=document.getElementById("results-container"),B=document.getElementById("classification"),F=document.getElementById("final-score"),S=document.getElementById("assessment-list");let p=null;async function b(){const e=await m.tabs.query({active:!0,currentWindow:!0});e&&e[0]&&(p=e[0],a.debug(i,"Current tab updated",p.url))}b(),m.tabs.onActivated.addListener(b),m.tabs.onUpdated.addListener(b);function o(e,n,t=""){switch(h.classList.remove("hidden"),l.classList.add("hidden"),h.className="status-box",e){case"fetching":h.classList.add("status-fetching"),E.innerHTML='<div class="spinner"></div>';break;case"analyzing":h.classList.add("status-analyzing"),E.innerHTML='<div class="spinner"></div>';break;case"success":h.classList.add("status-success"),E.innerHTML='<svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';break;case"error":h.classList.add("status-error"),E.innerHTML='<svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';break}k.textContent=n,t?(A.textContent=t,A.classList.remove("hidden")):A.classList.add("hidden")}l.addEventListener("click",async()=>{if(a.debug(i,"Analyze button clicked"),!p){const e=await m.tabs.query({active:!0,currentWindow:!0});e&&e[0]&&(p=e[0])}if(!p||!p.url){o("error",y.NO_ACTIVE_TAB,"Please make sure you have a webpage open.");return}o("fetching","Requesting permission...","Please grant access when prompted");try{const e=new URL(p.url).origin+"/*";if(a.debug(i,"Requesting permission for",e),!await m.permissions.request({origins:[e]})){a.warn(i,"Permission denied"),o("error",y.PERMISSION_DENIED,"Please grant access to this website to analyze its content.");return}a.debug(i,"Permission granted, requesting extraction"),o("fetching","Fetching page text...","Please wait while we extract text from the current page");try{await m.runtime.sendMessage({type:"ra_request_extraction"}),a.debug(i,"Extraction request sent")}catch(t){const s=t;a.error(i,"Failed to send extraction request",s),o("error","Failed to communicate with background script",s.message)}}catch(e){const n=e;a.error(i,"Error in analyze button handler",n),o("error","Failed to request permission",n.message)}});async function D(e,n){let t=e;e.length>M.MAX_TEXT_LENGTH?(t=e.substring(0,M.MAX_TEXT_LENGTH),o("analyzing","Analyzing text...",`Note: Text truncated to ${M.MAX_TEXT_LENGTH} characters for analysis`)):o("analyzing","Analyzing text...","Running reliability assessment");try{a.debug(i,"Analyzing extracted text",{length:t.length});const s=await G(t);H(s),o("success","Analysis complete!","Results displayed below")}catch(s){const r=s;a.error(i,"Analysis error",r),r.message.includes("API Key")||r.message.includes("Settings")?o("error","Analysis failed","Please check your settings and ensure your API key is configured correctly."):r.message.includes("Ollama")?o("error","Analysis failed",y.OLLAMA_CONNECTION_FAILED):r.message.includes("timeout")||r.message.includes("aborted")?o("error","Analysis failed","Request timed out. Please try again."):o("error","Analysis failed",r.message)}}function q(e){o("error","Failed to extract text",e)}window.handleExtractedText=D,window.handleExtractionError=q;async function G(e){const n=await m.storage.sync.get([f.SELECTED_MODEL,f.GEMINI_API_KEY]),t=n[f.SELECTED_MODEL]||"gemini";if(t==="gemini"){if(!n[f.GEMINI_API_KEY])throw new Error(y.API_KEY_MISSING);return await z(e,n[f.GEMINI_API_KEY])}else{if(t==="mistral")return await U(e);throw new Error(y.INVALID_MODEL)}}async function z(e,n){const t=`${g.GEMINI.BASE_URL}/models/${g.GEMINI.MODEL}:generateContent`,s={systemInstruction:{parts:[{text:_}]},contents:[{parts:[{text:`Text to Analyze: "${e}"`}]}],generationConfig:{responseMimeType:g.GEMINI.MIME_TYPE,responseSchema:Y,temperature:g.GEMINI.TEMPERATURE}},r=new AbortController,c=setTimeout(()=>r.abort(),g.TIMEOUT_MS);try{const d=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":n},body:JSON.stringify(s),signal:r.signal});if(clearTimeout(c),!d.ok){const u=await d.text();throw new Error(`${y.API_REQUEST_FAILED}: ${d.status} - ${u}`)}const T=await d.json();try{return JSON.parse(T.candidates[0].content.parts[0].text)}catch{throw new Error(y.JSON_PARSE_FAILED)}}catch(d){throw clearTimeout(c),d.name==="AbortError"?new Error("Request timeout: Analysis took too long. Please try with a shorter text."):d}}async function U(e){const n=_+`

You MUST respond with ONLY the JSON object.`,t={model:g.MISTRAL.MODEL,messages:[{role:"system",content:n},{role:"user",content:`Text to Analyze: "${e}"`}],format:"json",stream:!1},s=new AbortController,r=setTimeout(()=>s.abort(),g.TIMEOUT_MS);try{const c=await fetch(g.MISTRAL.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:s.signal});if(clearTimeout(r),!c.ok)throw new Error(`Local API request failed: ${c.status}`);const d=await c.json();return JSON.parse(d.message.content)}catch(c){throw clearTimeout(r),c.name==="AbortError"?new Error("Request timeout: Analysis took too long. Please try with a shorter text."):c.message.includes("Failed to fetch")?new Error(y.OLLAMA_CONNECTION_FAILED):c}}function H(e){F.textContent=e.finalScore.toFixed(1),B.textContent=e.classification;const n=document.getElementById("score-header");n.className="score-header";let t="",s="";switch(e.classification){case"Factual":t="type-factual",s="var(--green-600)";break;case"Opinion":t="type-opinion",s="var(--blue-600)";break;case"Fiction":t="type-fiction",s="var(--purple-600)";break}n.classList.add(t);const r=document.querySelector(".score-body"),c=document.querySelector(".reliability-label"),d=document.querySelector(".final-score-value"),T=document.querySelector(".score-max");if(r.style.borderColor=s,c.style.color=s,d.style.color=s,T.style.color=s,S.innerHTML="",e.rawAssessment&&e.rawAssessment.length>0)e.rawAssessment.forEach(u=>{const w=document.createElement("div");w.className="assessment-item";const I=document.createElement("div");I.className="assessment-header";const x=document.createElement("h4");x.className="assessment-indicator",x.textContent=u.indicator;const L=document.createElement("span");L.className=`assessment-score ${j(u.score)}`,L.textContent=u.score.toFixed(1),I.appendChild(x),I.appendChild(L);const v=document.createElement("p");v.className="assessment-analysis",v.textContent=u.analysis,w.appendChild(I),w.appendChild(v),S.appendChild(w)});else{const u=document.createElement("p");u.className="text-gray-500",u.textContent="No detailed assessment provided.",S.appendChild(u)}R.classList.remove("hidden")}function j(e){return e>=O.HIGH?"text-green":e>=O.MEDIUM?"text-yellow":"text-red"}const C=document.getElementById("view-details-link"),N=document.getElementById("raw-assessment-details");C.addEventListener("click",e=>{e.preventDefault(),N.classList.toggle("hidden"),C.textContent=N.classList.contains("hidden")?"Review full assessment":"Hide full assessment"}),P.addEventListener("click",()=>m.runtime.openOptionsPage())});
