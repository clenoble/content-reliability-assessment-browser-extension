import{b as o,S as t,E as c}from"./chunks/constants-D7P0j8Gc.js";import{l as r}from"./chunks/logger-GwZmU3gw.js";const a="background";o.sidePanel&&o.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(s=>r.error(a,"Failed to set panel behavior",s));o.runtime.onMessage.addListener((s,e)=>s.type==="ra_request_extraction"?(r.debug(a,"Received extraction request from sidepanel"),u(),Promise.resolve({ok:!0})):Promise.resolve({ok:!1}));async function u(){try{const s=await o.tabs.query({active:!0,currentWindow:!0});if(!s||!s[0]){r.error(a,"No active tab found"),await o.storage.local.set({[t.EXTRACTION_ERROR]:c.NO_ACTIVE_TAB,[t.TIMESTAMP]:Date.now()});return}const e=s[0];if(r.debug(a,"Found active tab",{id:e.id,url:e.url}),!e.url||!/^https?:\/\//i.test(e.url)){r.warn(a,"Not a valid http(s) page",e.url),await o.storage.local.set({[t.EXTRACTION_ERROR]:c.INVALID_URL,[t.TIMESTAMP]:Date.now()});return}try{const n=await o.scripting.executeScript({target:{tabId:e.id},func:()=>document.body.innerText});if(!n||!n[0]||!n[0].result)throw new Error(c.EXTRACTION_FAILED);const i=n[0].result.replace(/\s+/g," ").trim();r.debug(a,"Successfully extracted text",{length:i.length});const l={id:e.id,url:e.url,title:e.title||""};await o.storage.local.set({[t.EXTRACTED_TEXT]:i,[t.TAB_INFO]:l,[t.TIMESTAMP]:Date.now()}),r.debug(a,"Stored extracted text in local storage");try{await o.runtime.sendMessage({type:"ra_text_extracted",text:i,tabInfo:l}),r.debug(a,"Message delivered to sidepanel")}catch(d){r.warn(a,"Could not send message to sidepanel",d)}}catch(n){const i=n;r.error(a,"Script injection failed",i),await o.storage.local.set({[t.EXTRACTION_ERROR]:`Failed to extract text: ${i.message}`,[t.TIMESTAMP]:Date.now()})}}catch(s){const e=s;r.error(a,"Extraction handling failed",e),await o.storage.local.set({[t.EXTRACTION_ERROR]:`Unexpected error: ${e.message}`,[t.TIMESTAMP]:Date.now()})}}
